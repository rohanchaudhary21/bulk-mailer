<!DOCTYPE html>
<html>
<head>
  <title>BulkMailer Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Google Sans', 'Roboto', sans-serif;
      background: #f6f8fc;
    }
    
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .header {
      padding: 20px 24px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 400;
      color: #202124;
    }
    
    .compose-field {
      padding: 12px 24px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
    }
    
    .compose-field label {
      width: 80px;
      color: #5f6368;
      font-size: 14px;
    }
    
    .compose-field input[type="text"],
    .compose-field textarea {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      font-family: inherit;
      resize: none;
    }
    
    .recipient-count {
      background: #e8f0fe;
      color: #1967d2;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 13px;
      margin-left: 8px;
    }
    
    .editor-container {
      padding: 24px;
      min-height: 300px;
    }
    
    #editor {
      min-height: 250px;
      border: none;
      font-size: 14px;
    }
    
    .ql-toolbar {
      border: none !important;
      border-bottom: 1px solid #e0e0e0 !important;
      padding: 8px 24px !important;
    }
    
    .ql-container {
      border: none !important;
      font-family: inherit;
    }
    
    .attachment-area {
      padding: 12px 24px;
      border-top: 1px solid #e0e0e0;
    }
    
    .attachment-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #f1f3f4;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #5f6368;
    }
    
    .attachment-button:hover {
      background: #e8eaed;
    }
    
    .attachment-list {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .attachment-item {
      background: #e8f0fe;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .attachment-item button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #5f6368;
    }
    
    .options-bar {
      padding: 16px 24px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .option-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .option-group label {
      font-size: 13px;
      color: #5f6368;
    }
    
    .option-group input[type="number"],
    .option-group input[type="datetime-local"] {
      padding: 6px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .actions {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .send-button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .send-button:hover {
      background: #1765cc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .schedule-button {
      background: white;
      color: #5f6368;
      border: 1px solid #dadce0;
      padding: 10px 24px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .schedule-button:hover {
      background: #f8f9fa;
    }
    
    .info-box {
      margin: 16px 24px;
      padding: 12px;
      background: #e8f0fe;
      border-left: 4px solid #1a73e8;
      border-radius: 4px;
      font-size: 13px;
      color: #174ea6;
    }
    
    .variable-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .chip {
      background: #e8f0fe;
      color: #1a73e8;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-family: monospace;
      cursor: pointer;
      border: 1px solid #d2e3fc;
    }
    
    .chip:hover {
      background: #d2e3fc;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚úâÔ∏è New Bulk Email</h1>
  </div>
  
  <!-- Analytics Widget -->
  <div id="analyticsWidget" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 500;">üìä Campaign Analytics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
      <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600;" id="totalSent">-</div>
        <div style="font-size: 12px; opacity: 0.9;">Emails Sent</div>
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600;" id="openRate">-</div>
        <div style="font-size: 12px; opacity: 0.9;">Open Rate</div>
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600;" id="clickRate">-</div>
        <div style="font-size: 12px; opacity: 0.9;">Click Rate</div>
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600;" id="totalOpened">-</div>
        <div style="font-size: 12px; opacity: 0.9;">Total Opens</div>
      </div>
    </div>
  </div>
  
  <form id="emailForm" method="POST" action="/send" enctype="multipart/form-data">
    
    <!-- Recipients -->
    <div class="compose-field">
      <label>To</label>
      <input type="text" name="recipients" id="recipients" placeholder="Enter emails (comma separated) or use Google Sheet URL below">
      <span class="recipient-count hidden" id="recipientCount">0 recipients</span>
    </div>
    
    <!-- Google Sheet -->
    <div class="compose-field">
      <label>Sheet URL</label>
      <input type="text" name="sheet" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
      <button type="button" id="detectColumns" class="attachment-button" style="margin-left: 8px;">
        üîç Detect Columns
      </button>
    </div>
    
    <!-- Sheet Info -->
    <div id="sheetInfo" class="info-box" style="display: none; margin: 16px 24px; background: #e8f5e9; border-color: #4caf50;">
      <strong>‚úÖ Sheet Detected:</strong>
      <div id="sheetDetails"></div>
    </div>
    
    <!-- Subject -->
    <div class="compose-field">
      <label>Subject</label>
      <input type="text" name="subject" id="subject" placeholder="Email subject" required>
    </div>
    
    <!-- Variable Chips - Dynamic -->
    <div class="info-box" id="variableInfo" style="display: none;">
      <strong>üí° Personalize your emails:</strong> Click to insert variables from your sheet
      <div class="variable-chips" id="subjectChips"></div>
    </div>
    
    <!-- Rich Text Editor -->
    <div class="ql-toolbar-container">
      <div id="toolbar">
        <span class="ql-formats">
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button>
        </span>
        <span class="ql-formats">
          <select class="ql-align"></select>
        </span>
        <span class="ql-formats">
          <button class="ql-clean"></button>
        </span>
      </div>
    </div>
    
    <div class="editor-container">
      <div id="editor"></div>
    </div>
    
    <!-- Hidden input for body content -->
    <input type="hidden" name="body" id="bodyContent">
    
    <!-- Variable Chips for Body - Dynamic -->
    <div style="padding: 0 24px 16px; display: none;" id="bodyChipsContainer">
      <div class="variable-chips" id="bodyChips"></div>
    </div>
    
    <!-- Attachments -->
    <div class="attachment-area">
      <label for="fileInput" class="attachment-button">
        üìé Attach Files
      </label>
      <input type="file" id="fileInput" name="attachments" multiple style="display: none;">
      <div class="attachment-list" id="attachmentList"></div>
    </div>
    
    <!-- Options -->
    <div class="options-bar">
      <div class="option-group">
        <label>Delay:</label>
        <input type="number" name="delay" value="10" min="1" max="60"> seconds
      </div>
      
      <div class="option-group hidden" id="scheduleGroup">
        <label>Schedule for:</label>
        <input type="datetime-local" name="time" id="scheduleTime">
      </div>
    </div>
    
    <!-- Actions -->
    <div class="actions">
      <div>
        <button type="submit" class="send-button" name="send_type" value="now">
          <span>‚û§</span> Send Now
        </button>
        <button type="button" class="schedule-button" onclick="toggleSchedule()">
          üïê Schedule Send
        </button>
      </div>
      <a href="/logout" style="color: #5f6368; font-size: 14px; text-decoration: none;">Logout</a>
    </div>
    
  </form>
</div>

<script>
  // Load analytics on page load
  async function loadAnalytics() {
    try {
      const response = await fetch('/api/analytics');
      const data = await response.json();
      
      if (response.ok) {
        document.getElementById('totalSent').textContent = data.total_sent;
        document.getElementById('openRate').textContent = data.open_rate + '%';
        document.getElementById('clickRate').textContent = data.click_rate + '%';
        document.getElementById('totalOpened').textContent = data.total_opened;
      }
    } catch (error) {
      console.error('Failed to load analytics:', error);
    }
  }
  
  // Load analytics when page loads
  loadAnalytics();
  
  // Refresh analytics every 30 seconds
  setInterval(loadAnalytics, 30000);
  
  // Initialize Quill editor
  var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: '#toolbar'
    },
    placeholder: 'Compose your email...'
  });
  
  // Update hidden body field on form submit
  document.getElementById('emailForm').addEventListener('submit', function() {
    document.getElementById('bodyContent').value = quill.root.innerHTML;
  });
  
  // Insert variable into subject
  function insertToSubject(variable) {
    const field = document.getElementById('subject');
    const start = field.selectionStart;
    const end = field.selectionEnd;
    const text = field.value;
    field.value = text.substring(0, start) + variable + text.substring(end);
    field.focus();
    field.selectionStart = field.selectionEnd = start + variable.length;
  }
  
  // Insert variable into editor
  function insertToEditor(variable) {
    const range = quill.getSelection(true);
    quill.insertText(range.index, variable);
    quill.setSelection(range.index + variable.length);
  }
  
  // File attachment handling
  const fileInput = document.getElementById('fileInput');
  const attachmentList = document.getElementById('attachmentList');
  
  fileInput.addEventListener('change', function() {
    attachmentList.innerHTML = '';
    Array.from(this.files).forEach((file, index) => {
      const item = document.createElement('div');
      item.className = 'attachment-item';
      item.innerHTML = `
        üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)
        <button type="button" onclick="removeAttachment(${index})">√ó</button>
      `;
      attachmentList.appendChild(item);
    });
  });
  
  function removeAttachment(index) {
    const dt = new DataTransfer();
    const files = fileInput.files;
    
    for (let i = 0; i < files.length; i++) {
      if (i !== index) dt.items.add(files[i]);
    }
    
    fileInput.files = dt.files;
    fileInput.dispatchEvent(new Event('change'));
  }
  
  // Recipient count
  function updateRecipientCount() {
    const manualInput = document.getElementById('recipients').value;
    const sheetInput = document.getElementById('sheetUrl').value;
    const countElement = document.getElementById('recipientCount');
    
    if (manualInput) {
      const count = manualInput.split(',').filter(e => e.trim()).length;
      countElement.textContent = `${count} recipient${count !== 1 ? 's' : ''}`;
      countElement.classList.remove('hidden');
    } else if (sheetInput) {
      countElement.textContent = 'From Google Sheet';
      countElement.classList.remove('hidden');
    } else {
      countElement.classList.add('hidden');
    }
  }
  
  document.getElementById('recipients').addEventListener('input', updateRecipientCount);
  document.getElementById('sheetUrl').addEventListener('input', updateRecipientCount);
  
  // Detect columns from Google Sheet
  let detectedColumns = [];
  
  document.getElementById('detectColumns').addEventListener('click', async function() {
    const sheetUrl = document.getElementById('sheetUrl').value;
    if (!sheetUrl) {
      alert('Please enter a Google Sheet URL first');
      return;
    }
    
    this.textContent = '‚è≥ Loading...';
    this.disabled = true;
    
    try {
      const response = await fetch('/api/sheet-columns', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sheet_url: sheetUrl })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        detectedColumns = data.columns;
        
        // Show sheet info
        const sheetInfo = document.getElementById('sheetInfo');
        const sheetDetails = document.getElementById('sheetDetails');
        
        if (data.has_email) {
          sheetDetails.innerHTML = `
            üìä Found ${data.total_rows} rows<br>
            üìã Columns detected: ${data.columns.join(', ')}<br>
            ‚úâÔ∏è Email column: Found
          `;
          sheetInfo.style.display = 'block';
          
          // Update variable chips
          updateVariableChips(data.columns);
          
          // Update recipient count
          document.getElementById('recipientCount').textContent = `${data.total_rows} recipients`;
          document.getElementById('recipientCount').classList.remove('hidden');
        } else {
          alert('‚ùå Sheet must have an "email" column');
        }
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Failed to load sheet: ' + error.message);
    } finally {
      this.textContent = 'üîç Detect Columns';
      this.disabled = false;
    }
  });
  
  // Update variable chips with detected columns
  function updateVariableChips(columns) {
    const subjectChips = document.getElementById('subjectChips');
    const bodyChips = document.getElementById('bodyChips');
    
    // Clear existing chips
    subjectChips.innerHTML = '';
    bodyChips.innerHTML = '';
    
    // Add chips for each column
    columns.forEach(col => {
      const variable = `{{ '{{' }} ${col} {{ '}}' }}`;
      
      // Subject chip
      const subjectChip = document.createElement('span');
      subjectChip.className = 'chip';
      subjectChip.textContent = variable;
      subjectChip.onclick = () => insertToSubject(variable);
      subjectChips.appendChild(subjectChip);
      
      // Body chip
      const bodyChip = document.createElement('span');
      bodyChip.className = 'chip';
      bodyChip.textContent = variable;
      bodyChip.onclick = () => insertToEditor(variable);
      bodyChips.appendChild(bodyChip);
    });
    
    // Also add email chip
    const emailVar = `{{ '{{' }} email {{ '}}' }}`;
    
    const emailSubjectChip = document.createElement('span');
    emailSubjectChip.className = 'chip';
    emailSubjectChip.textContent = emailVar;
    emailSubjectChip.onclick = () => insertToSubject(emailVar);
    subjectChips.appendChild(emailSubjectChip);
    
    const emailBodyChip = document.createElement('span');
    emailBodyChip.className = 'chip';
    emailBodyChip.textContent = emailVar;
    emailBodyChip.onclick = () => insertToEditor(emailVar);
    bodyChips.appendChild(emailBodyChip);
    
    // Show the chip containers
    document.getElementById('variableInfo').style.display = 'block';
    document.getElementById('bodyChipsContainer').style.display = 'block';
  }
  
  // Schedule toggle
  let scheduleMode = false;
  function toggleSchedule() {
    scheduleMode = !scheduleMode;
    const scheduleGroup = document.getElementById('scheduleGroup');
    const sendButton = document.querySelector('.send-button');
    
    if (scheduleMode) {
      scheduleGroup.classList.remove('hidden');
      sendButton.setAttribute('name', 'send_type');
      sendButton.setAttribute('value', 'schedule');
      sendButton.innerHTML = '<span>üïê</span> Schedule';
      document.getElementById('scheduleTime').required = true;
    } else {
      scheduleGroup.classList.add('hidden');
      sendButton.setAttribute('value', 'now');
      sendButton.innerHTML = '<span>‚û§</span> Send Now';
      document.getElementById('scheduleTime').required = false;
    }
  }
</script>

</body>
</html>
